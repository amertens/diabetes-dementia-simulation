rm(list=ls())
library(here)
source(here::here("0_config.R"))
gc()
d_wide_list <- readRDS(file=here("data/null_simulated_data_list_subsampled.RDS"))
source(here::here("0_config.R"))
rm(list=ls())
library(lava)
library(data.table)
source(paste0(here::here(),"/synthesizeDD.R"))
rm(list=ls())
library(lava)
library(data.table)
source(paste0(here::here(),"/synthesizeDD.R"))
rm(list=ls())
library(lava)
library(data.table)
source(paste0(here::here(),"/functions/0_synthesizeDD.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
rm(list=ls())
library(lava)
library(data.table)
source(paste0(here::here(),"/functions/0_synthesizeDD.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
cc <- fread(paste0(here::here(),"/data/coefficients.txt"))
u <- synthesizeDD(cc)
calc_sim_truth
set.seed(12345)
sim_list <- NULL
n<-200
N_time=10
#calc truth
sim_truth <- calc_sim_truth(cc)
cRD <- sim_truth$cRD
cRR <- sim_truth$cRR
cRD
cRR
set.seed(12345)
sim_list <- NULL
n<-200
N_time=10
for(i in 1:n){
cat("\ni: ",i,"\n")
d <- sim(u,115698)
d$dem_prev <-    mean(1*(d$event_dementia_1 +
d$event_dementia_2 +
d$event_dementia_3 +
d$event_dementia_4 +
d$event_dementia_5 +
d$event_dementia_6 +
d$event_dementia_7 +
d$event_dementia_8 +
d$event_dementia_9 +
d$event_dementia_10 >0))
d<- clean_sim_data(d, N_time = 10)
sim_list[[i]] <- d
gc()
}
rm(list=ls())
library(lava)
library(data.table)
source(paste0(here::here(),"/functions/0_synthesizeDD.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
cc <- fread(paste0(here::here(),"/data/coefficients.txt"))
u <- synthesizeDD(cc)
set.seed(12345)
sim_list <- NULL
n<-200
N_time=10
for(i in 1:n){
cat("\ni: ",i,"\n")
d <- sim(u,115698)
d$dem_prev <-    mean(1*(d$event_dementia_1 +
d$event_dementia_2 +
d$event_dementia_3 +
d$event_dementia_4 +
d$event_dementia_5 +
d$event_dementia_6 +
d$event_dementia_7 +
d$event_dementia_8 +
d$event_dementia_9 +
d$event_dementia_10 >0))
d<- clean_sim_data(d, N_time = 10)
sim_list[[i]] <- d
gc()
}
saveRDS(sim_list, paste0(here::here(),"/data/simulated_data_list.RDS"))
rm(list=ls())
library(lava)
library(data.table)
source(paste0(here::here(),"/functions/0_synthesizeDD.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
sim_list <- readRDS(paste0(here::here(),"/data/simulated_data_list.RDS"))
sim_list_null<-list()
for(i in 1:length(sim_list)){
d <- sim_list[[i]]
Y <- d %>% select(starts_with("event_")|starts_with("censor_"))
set.seed(123)
Y <- Y[sample(nrow(Y)),]
d <- d %>% select(!starts_with("event_")&!starts_with("censor_"))
d <- bind_cols(d, Y)
sim_list_null[[i]] <- d
}
saveRDS(sim_list_null, paste0(here::here(),"/data/simulated_data_list_old_null.RDS"))
rm(list=ls())
source(here::here("0_config.R"))
rm(list=ls())
source(here::here("0_config.R"))
rm(list=ls())
source(here::here("0_config.R"))
source(paste0(here::here(),"0_config.R"))
source(paste0(here::here(),"/0_config.R"))
source("~/diabetes-dementia-simulation/0_config.R", echo=TRUE)
source("~/diabetes-dementia-simulation/0_config.R", echo=TRUE)
#load functions
source(paste0(here::here(),"/functions/0_diabetes_dementia_functions.R"))
source("~/diabetes-dementia-simulation/0_config.R", echo=TRUE)
rm(list=ls())
source(paste0(here::here(),"/0_config.R"))
source(paste0(here::here(),"/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
source(paste0(here::here(),"/functions/0_simulation_cleaning_functions.R"))
cc <- fread(paste0(here::here(),"/data/coefficients.txt"))
source("~/diabetes-dementia-simulation/simulation_protective/calculate_truth.R", echo=TRUE)
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/0_ltmle_Estimate_update.R"))
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
d_wide_list <- readRDS(file=here("data/simulated_data_list_null.RDS"))
rm(list=ls())
library(here)
source(paste0(here::here(),"0_config.R"))
rm(list=ls())
library(here)
source(paste0(here::here(),"/0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
d_wide_list <- readRDS(file=here("data/simulated_data_list_null.RDS"))
rm(list=ls())
library(here)
source(paste0(here::here(),"/0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
d_wide_list <- readRDS(file=paste0(here::here(),"data/simulated_data_list_null.RDS"))
rm(list=ls())
library(here)
source(paste0(here::here(),"/0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
d_wide_list <- readRDS(file=paste0(here::here(),"data/simulated_data_list_null.RDS"))
d_wide_list <- readRDS(file=paste0(here::here(),"/data/simulated_data_list_null.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
#--------------------------------------------------------------------------
# GLM
#--------------------------------------------------------------------------
resdf_noDetQ_ic_glm <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=FALSE, varmethod = "ic",N_time=11, SL.library="glm"))
return(res)
}
rm(list=ls())
library(here)
source(paste0(here::here(),"/0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
detectCores()
registerDoParallel(cores=64)
resdf_noDetQ_ic_glm <- NULL
for(i in 1:length(d_wide_list)){
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=FALSE, varmethod = "ic",N_time=11, SL.library="glm"))
resdf_noDetQ_ic_glm <- bind_rows(resdf_noDetQ_ic_glm, res)
}
d_wide_list <- readRDS(file=paste0(here::here(),"/data/simulated_data_list_null.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
#TEMP! No parallelization:
resdf_noDetQ_ic_glm <- NULL
for(i in 1:length(d_wide_list)){
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=FALSE, varmethod = "ic",N_time=11, SL.library="glm"))
resdf_noDetQ_ic_glm <- bind_rows(resdf_noDetQ_ic_glm, res)
}
resdf_noDetQ_ic_glm
resdf_noDetQ_ic_glm <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=FALSE, varmethod = "ic",N_time=11, SL.library="glm"))
return(res)
}
saveRDS(resdf_noDetQ_ic_glm, paste0(here::here(),"/sim_res/null/sim_res_noDetQ_ic_glm.RDS"))
resdf_noDetQ_ic_glm
resdf_ic_glm <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=TRUE, varmethod = "ic",N_time=11, SL.library="glm"))
return(res)
}
#---------------------------------------------------------
# manuscript sim results: Null sim
#---------------------------------------------------------
files <- dir(path=paste0(here::here(),"/sim_res/null/"), pattern = "*.RDS")
files
files <- dir(path=paste0(here::here(),"/sim_res/null/"), pattern = "*.RDS")
files
#load bootstrap
boot_iter_files <- dir(path=paste0(here::here(),"/sim_res/null//bootstrap/"), pattern = "*.RDS")
boot_iter_files
length(boot_iter_files)
trueRR=1
trueRD=0
iptw=T
original_sim_res_null <- calc_sim_performance(files=files, boot_iter_files=boot_iter_files, trueRR=1, trueRD=0, iptw=T)
source(here::here("0_config.R"))
source(paste0(here::here(),"/0_ltmle_Estimate_update.R"))
rm(list=ls())
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
source(paste0(here::here(),"/functions/0_simulation_cleaning_functions.R"))
trueRR=1
trueRD=0
iptw=T
original_sim_res_null <- calc_sim_performance(files=files, boot_iter_files=boot_iter_files, trueRR=1, trueRD=0, iptw=T)
#---------------------------------------------------------
# manuscript sim results: Null sim
#---------------------------------------------------------
files <- dir(path=paste0(here::here(),"/sim_res/null/"), pattern = "*.RDS")
# #NOTE: check which files are missing from the old pipeline:
# old_files <- dir(path=paste0(here::here(),"/sim_res_old/"), pattern = "*.RDS")
# old_files <- old_files[grepl("old_null_sim_res_",old_files)]
# files_temp[!(files_temp %in% old_files)]
# old_files[!(old_files %in% files_temp)]
#load bootstrap
boot_iter_files <- dir(path=paste0(here::here(),"/sim_res/null//bootstrap/"), pattern = "*.RDS")
length(boot_iter_files)
trueRR=1
trueRD=0
iptw=T
original_sim_res_null <- calc_sim_performance(files=files, boot_iter_files=boot_iter_files, trueRR=1, trueRD=0, iptw=T)
source("~/diabetes-dementia-simulation/functions/0_simulation_cleaning_functions.R", echo=TRUE)
original_sim_res_null <- calc_sim_performance(files=files, filepath="/sim_res/null/", boot_iter_files=boot_iter_files, trueRR=1, trueRD=0, iptw=T)
original_sim_res_null$perf_tab_diff
original_sim_res_null <- calc_sim_performance(files=files, filepath="/sim_res/null/", boot_iter_files=boot_iter_files, trueRD=0, iptw=T)
source("~/diabetes-dementia-simulation/functions/0_simulation_cleaning_functions.R", echo=TRUE)
original_sim_res_null <- calc_sim_performance(files=files, filepath="/sim_res/null/", boot_iter_files=boot_iter_files, trueRD=0, iptw=T)
original_sim_res_null
original_sim_res_null$filenames
truth <- readRDS(paste0(here::here(),"/data/sim_res_truth.RDS"))
truth
trueRD <- truth[10,2]
trueRD
saveRDS(sim_res_protective,  file=paste0(here::here(),"/results/sim_performance_results_protective.RDS"))
rm(list=ls())
library(here)
source(paste0(here::here(),"/0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
d_wide_list <- readRDS(file=paste0(here::here(),"/data/simulated_data_list_null.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
resdf_ic_glm <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=TRUE, varmethod = "ic",N_time=11, SL.library="glm"))
return(res)
}
saveRDS(resdf_ic_glm, paste0(here::here(),"/sim_res/null/sim_res_ic_glm.RDS"))
resdf_Qint_noDetQ_ic_glm <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=FALSE, varmethod = "ic",N_time=11, SL.library="glm"))
return(res)
}
saveRDS(resdf_Qint_noDetQ_ic_glm, paste0(here::here(),"/sim_res/null/sim_res_Qint_noDetQ_ic_glm.RDS"))
resdf_Qint_ic_glm <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q=TRUE, varmethod = "ic",N_time=11, SL.library="glm"))
return(res)
}
saveRDS(resdf_Qint_ic_glm, paste0(here::here(),"/sim_res/null/sim_res_Qint_ic_glm.RDS"))
#--------------------------------------------------------------------------
#Random forest
#--------------------------------------------------------------------------
int.start.time <- Sys.time()
resdf_RF <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows') %dopar% {
res <- run_ltmle_glmnet(d_wide_list[[i]], varmethod = "ic", resdf=NULL, SL.library="SL.randomForest", N_time=11, override_function=SuperLearner_override_RF)
}
run_ltmle_glmnet
#--------------------------------------------------------------------------
#Random forest
#--------------------------------------------------------------------------
int.start.time <- Sys.time()
resdf_RF <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows') %dopar% {
res <- run_ltmle_glmnet(d_wide_list[[i]], varmethod = "ic", resdf=NULL, SL.library="SL.randomForest", det.Q=F, N_time=11, override_function=SuperLearner_override_RF)
}
int.end.time <- Sys.time()
difftime(int.end.time, int.start.time, units="mins")
resdf_RF
gc()
saveRDS(resdf_RF, paste0(here::here(),"/sim_res/null/sim_res_rf_ic.RDS"))
int.start.time <- Sys.time()
resdf_RF_detQ <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows') %dopar% {
res <- run_ltmle_glmnet(d_wide_list[[i]], varmethod = "ic", resdf=NULL, SL.library="SL.randomForest", det.Q=T, N_time=11, override_function=SuperLearner_override_RF)
}
int.end.time <- Sys.time()
difftime(int.end.time, int.start.time, units="mins")
gc()
saveRDS(resdf_RF_detQ, paste0(here::here(),"/sim_res/null/sim_res_rf_ic.RDS"))
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
#lasso
int.start.time <- Sys.time()
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q =FALSE, varmethod = "ic"))
return(res)
}
gc()
d_wide_list <- readRDS(file=here("data/simulated_data_list.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
#lasso
int.start.time <- Sys.time()
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q =FALSE, varmethod = "ic"))
return(res)
}
int.end.time <- Sys.time()
difftime(int.end.time, int.start.time, units="mins")
saveRDS(resdf_DetQ_ic, paste0(here::here(),"/data/sim_res_ic.RDS"))
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q =TRUE, varmethod = "ic"))
return(res)
}
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
gc()
d_wide_list <- readRDS(file=here("data/simulated_data_list.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=FALSE, det.Q =TRUE, varmethod = "ic"))
return(res)
}
saveRDS(resdf_DetQ_ic, paste0(here::here(),"/sim_res/protective/sim_res_DetQ_ic.RDS"))
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=TRUE, det.Q =FALSE, varmethod = "ic"))
return(res)
}
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
gc()
d_wide_list <- readRDS(file=here("data/simulated_data_list.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=TRUE, det.Q =FALSE, varmethod = "ic"))
return(res)
}
saveRDS(resdf_DetQ_ic, paste0(here::here(),"/sim_res/protective/sim_res_Qint_ic.RDS"))
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=TRUE, det.Q =TRUE, varmethod = "ic"))
return(res)
}
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
gc()
d_wide_list <- readRDS(file=here("data/simulated_data_list.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
resdf_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=TRUE, det.Q =TRUE, varmethod = "ic"))
return(res)
}
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
gc()
d_wide_list <- readRDS(file=here("data/simulated_data_list.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
gc()
d_wide_list <- readRDS(file=here("data/simulated_data_list.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
resdf_Qint_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=TRUE, det.Q =TRUE, varmethod = "ic"))
return(res)
}
saveRDS(resdf_Qint_DetQ_ic, paste0(here::here(),"/sim_res/protective/sim_res_Qint_DetQ_ic.RDS"))
resdf_Qint_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=TRUE, det.Q =FALSE, varmethod = "ic"))
return(res)
}
rm(list=ls())
library(here)
source(here::here("0_config.R"))
source(paste0(here::here(),"/functions/0_ltmle_Estimate_update.R"))
source(paste0(here::here(),"/functions/0_simulation_functions.R"))
library(parallel)
library(doParallel)
registerDoParallel(cores=64)
gc()
d_wide_list <- readRDS(file=here("data/simulated_data_list.RDS"))
d_wide_list <- d_wide_list[1:200]
gc()
resdf_Qint_DetQ_ic <- foreach(i = 1:length(d_wide_list), .combine = 'bind_rows', .errorhandling = 'remove') %dopar% {
res <- NULL
try(res <- run_ltmle_glmnet(d_wide_list[[i]], resdf=NULL, Qint=TRUE, det.Q =TRUE, varmethod = "ic"))
return(res)
}
saveRDS(resdf_Qint_DetQ_ic, paste0(here::here(),"/sim_res/protective/sim_res_Qint_DetQ_ic.RDS"))
